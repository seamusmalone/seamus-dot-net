// Copyright 2001-2003, Nebiru Software
// www.domapi.com
core.loadUnit("sysutils");function XBMData(w,h,nm){this.width=core.rInt(w,16);this.height=core.rInt(h,16);this.nm=core.rVal(nm,"XBM");this.key=[1,2,4,8,16,32,64,128];this.raw="";this.clear()};XBMData.prototype.clear=function(){this.data=[];var w=parseInt(this.width/8);var line,a,b;for(a=0;a<this.height;a++){line=[];for(b=0;b<w;b++)line.push(0);this.data.push(line)}};XBMData.prototype.setPoint=function(x,y,b){var section=parseInt(x/8);var pos=x%8;var bitSet=this.data[y][section]&this.key[pos];if((b&&!bitSet)||(!b&&bitSet))this.data[y][section]=this.data[y][section] ^ this.key[pos]};XBMData.prototype.getPoint=function(x,y){var section=parseInt(x/8);var pos=x%8;return(this.data[y][section]&this.key[pos])!=0};XBMData.prototype.getData=function(asJS){var r=(asJS?"'":"")+"#define "+this.nm+"_width "+this.width+(asJS?"'+":"")+"\n"+(asJS?"'":"")+"#define "+this.nm+"_height "+this.height+(asJS?"'+":"")+"\n"+(asJS?"'":"")+"static char "+this.nm+"_bits[] = {"+(asJS?"'+\n":"");var a,b,t;var w=parseInt(this.width/8);for(a=0;a<this.height;a++){if(asJS)r+="'";for(b=0;b<w;b++){t=this.data[a][b].toString(16);r+='0x'+sysutils.padZeros(t,2)+','}if(asJS&&a<(this.height-1))r+="'+\n"}if(r.charAt(r.length-1)==",")r=r.substr(0,r.length-1);r+=(asJS?"'+\n'":"")+"};"+(asJS?"';":"");if(!asJS)this.raw=r;return r};XBMData.prototype.setData=function(s){var m="";try{m="getting name";var nm=s.match(/\s(.*)_width/i)[1];m="getting width";var w=s.match(/width\s(.*)\b/i)[1];m="getting height";var h=s.match(/height\s(.*)\b/i)[1];m="getting data";var d=s.match(/\{(.*)\}/)[1];if(w%2!=0)throw({message:"Width not a multiple of 8"});var ww=parseInt(w/8);m="splitting data";d=d.split(",");if(ww*h!=d.length)throw({message:"Number of data elements does not match width*height"});this.width=w;this.height=h;this.nm=nm;this.clear();m="loading data";var x=1;var y=0;var t;for(var a=0;a<d.length;a++){x=1-x;this.data[y][x]=parseInt(d[a],16);if(x==1)y++}this.raw=s}catch(E){alert("Error in XBM while "+m+"\n\n"+E.message+"\n\nPlease notify support@domapi.com of this problem\n\nInput was:\n"+s)}};
