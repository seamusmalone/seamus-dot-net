// Copyright 2001-2003, Nebiru Software
// www.domapi.com
core.loadUnit("keyboard");core.loadUnit("groups");core.selection=new Object();core.selection.elms=null;core.selection.allowed=null;core.selection.controls=new Object();core.selection.lookupControls=new Array();core.selection.lookupControls[0]='leftTop';core.selection.lookupControls[1]='centreTop';core.selection.lookupControls[2]='rightTop';core.selection.lookupControls[3]='rightMiddle';core.selection.lookupControls[4]='rightBottom';core.selection.lookupControls[5]='centreBottom';core.selection.lookupControls[6]='leftBottom';core.selection.lookupControls[7]='leftMiddle';core.selection._createControls=function(e){var c=e.selection.controls;l=core.selection.lookupControls;for(var i=0;i<8;i++){if((typeof core.selection.controls.image!='object')||(core.selection.controls.image[i]!=null)){c[i]=core.createElm(null,0,0);c[i].domAPIObjType="control";c[i].bringToFront()}else{c[i]=null}}};core.selection._initControls=function(e){var c=e.selection.controls;for(var a=0;a<c.length;a++){if(c[a]){c[a].setW(core.selection.controls.size);c[a].setH(core.selection.controls.size);c[a].setBgColor(core.selection.controls.color);c[a].parent=e;if(typeof core.selection.controls.image=="object"&&typeof core.selection.controls.image[a]=='string'){c[a].innerHTML='<img src="'+core.selection.controls.image[a]+'" width='+(core.selection.controls.size)+' height='+(core.selection.controls.size)+'>'}else{c[a].innerHTML=''}}}};core.selection._positionControls=function _positionControls(e){if((!e.selectionStatus)||((core.selection._deselectOnDrag)&&(e.selectionDrag)))return;var size=core.selection.controls.size;var offset=core.selection.controls.offset;var c=e.selection.controls;var trueOffset=core.getTrueOffset(e);x=trueOffset[0];y=trueOffset[1];if(c[0]){c[0].setX(x-offset,true);c[0].setY(y-offset,true)};if(c[1]){c[1].setX(x+(e.getW()/2)-(size/2),true);c[1].setY(y-offset,true)};if(c[2]){c[2].setX(x+e.getW()-size+offset,true);c[2].setY(y-offset,true)};if(c[3]){c[3].setX(x+e.getW()-size+offset,true);c[3].setY(y+(e.getH()/2)-(size/2),true)};if(c[4]){c[4].setX(x+e.getW()-size+offset,true);c[4].setY(y+e.getH()-size+offset,true)};if(c[5]){c[5].setX(x+(e.getW()/2)-(size/2),true);c[5].setY(y+e.getH()-size+offset,true)};if(c[6]){c[6].setX(x-offset,true);c[6].setY(y+e.getH()-size+offset,true)};if(c[7]){c[7].setX(x-offset,true);c[7].setY(y+(e.getH()/2)-(size/2),true)}};core.selection.on=function(){if(core.selection.status)return;core.selection.elms=new Array();core.addEvent(document,"click",core.selection._selectElm);core.selection.status=true};core.selection.off=function(){cs=core.selection;core.removeEvent(document,"click",cs.selectElm);cs.elms=null;core.selection.status=false};core.selection.setControls=function(deselectOnDrag,size,color,offset,image){var cs=core.selection;var ep=core.elmProto;cs.deselectOnDrag=core.rVal(deselectOnDrag,cs.deselectOnDrag);if(cs.deselectOnDrag!=null){if(cs.deselectOnDrag==true){if(cs.deselectOnDragOn==false){cs.deselectOnDragOn=true;ep.unRegHook('dragStart',cs._showControlsOnDrag);ep.regHook('dragStart',cs._removeControlsOnDrag)}}else if(cs.deselectOnDrag==false){if(cs.deselectOnDragOn==true){cs.deselectOnDragOn=false;ep.unRegHook('dragStart',cs._removeControlsOnDrag);ep.regHook('dragStart',cs._showControlsOnDrag)}}}var csc=core.selection.controls;csc.size=core.rInt(size,csc.size);if((offset==null)&&(!csc.size%2))csc.size++;csc.offset=core.rInt(offset,(csc.size+1)/2);csc.color=core.rVal(color,csc.color);if(image!=null)csc.image=(typeof image=="string")?new Array(image,image,image,image,image,image,image,image):image};core.selection._removeControlsOnDrag=function(e){core.selection._deselect(e);e.selectionDrag=true};core.selection._showControlsOnDrag=function(e){e.selectionDrag=true};core.selection._regParent=function(e,elm){var p=e.parentNode;if(!p.domAPIObjType)return false;if(!p.nestedSelectedElms)p.nestedSelectedElms=new Array();p.nestedSelectedElms[p.nestedSelectedElms.length]=elm;core.selection._regParent(p,elm)};core.selection._unRegParent=function(e,elm){var p=e.parentNode;if(!p.domAPIObjType)return false;if(p.nestedSelectedElms)p.nestedSelectedElms.deleteItem(p.nestedSelectedElms.indexOf(elm));core.selection._unRegParent(p,elm)};core.selection._positionChildrenControls=function(e){if(!e.nestedSelectedElms)return;for(var i=0;i<e.nestedSelectedElms.length;i++){core.selection._positionControls(e.nestedSelectedElms[i]);core.selection._positionChildrenControls(e.nestedSelectedElms[i])}};core.selection._select=function(e){e.bringToFront();var cs=core.selection;e.selection=new Object();var es=e.selection;es.controls=new Array();e.selectionStatus='init';cs._createControls(e);cs._initControls(e);if(e.resizeStatus)core.resize._select(e);cs._positionControls(e);core.selection._regParent(e,e);e.selectionStatus=true;cs.elms[cs.elms.length]=e;if(cs.onSelect)cs.onSelect(e)};core.selection._deselect=function(e){if(!e.selectionStatus)return;var c=e.selection.controls;var cs=core.selection;for(var a=0;a<c.length;a++){if(c[a])c[a].removeNode(true)}e.selectionStatus=false;if(e.resizeStatus)core.resize._deselect(e);cs._unRegParent(e,e);delete e.selection.controls;cs.elms.deleteItem(cs.elms.indexOf(e));if(cs.onDeSelect)cs.onDeSelect(e)};core.selection._deselectAll=function(){var elms=core.selection.elms;for(var a=0;a<elms.length;a++){core.selection._deselect(elms[a])}};core.selection._getElm=function(o){if(o==null){return null}else if(o.domAPIObjType){if((core.selection._isAllowed(o))&&(o.domAPIObjType!='control'))return o;else return "notAllowed"}else if((o.nodeName!='HTML')&&(o.nodeName!='BODY')&&(o.parentNode.nodeName!='BODY')){return core.selection._getElm(o.parentNode)}else{return null}};core.selection._isAllowed=function(o){var a=core.selection.allowed;if(!a){return true}else{for(var i=0;i<a.length;i++){if(a[i]==o){return true}else if(core.groups.groupExists(a[i])){if(o.isInGroup(a[i])){return true}}}return false}};core.selection.addAllowed=function(){for(var i=0;i<arguments.length;i++){o=arguments[i];if(!o.domAPIObjType&&!core.groups.groupExists(o))return;if(!core.selection.allowed){core.selection.allowed=new Array()}core.selection.allowed.push(o)}};core.selection.removeAllowed=function(){var a=core.selection.allowed;if(!a)return;for(var i=0;i<arguments.length;i++){o=arguments[i];a.deleteItem(a.indexOf(o))}};core.selection._selectElm=function(e){cs=core.selection;var select=cs._getElm(core.getTarget(e));if(select=="notAllowed"){return}if(select){if(select.selectionDrag){select.selectionDrag=false;return}if(!cs.elms){cs.elms=new Array()}var index=cs.elms.indexOf(select);if(!core.keyboard.isShift()){cs._deselectAll();cs.elms=new Array();core.elmProto.regHook('setX',core.selection._positionControls);core.elmProto.regHook('setX',core.selection._positionChildrenControls);core.elmProto.regHook('setY',core.selection._positionControls);core.elmProto.regHook('setY',core.selection._positionChildrenControls);core.elmProto.regHook('setW',core.selection._positionControls);core.elmProto.regHook('setH',core.selection._positionControls);core.elmProto.regHook('moveTo',core.selection._positionControls);if(index!=-1)return}if(index==-1)cs._select(select);else cs._deselect(select)}else{cs=core.selection;if(cs.elms){cs._deselectAll();cs.elms=null;if(core.selection.onClearSelection)core.selection.onClearSelection();core.elmProto.unRegHook('setX',core.selection._positionControls);core.elmProto.unRegHook('setX',core.selection._positionChildrenControls);core.elmProto.unRegHook('setY',core.selection._positionControls);core.elmProto.unRegHook('setY',core.selection._positionChildrenControls);core.elmProto.unRegHook('setW',core.selection._positionControls);core.elmProto.unRegHook('setH',core.selection._positionControls);core.elmProto.unRegHook('moveTo',core.selection._positionControls)}return}};core.selection.on();core.selection.deselectOnDragOn=false;core.selection.setControls(true,5,"green");core.elmProto.selectionStatus=false;
