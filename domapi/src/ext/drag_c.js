// Copyright 2001-2003, Nebiru Software
// www.domapi.com
core.drag={};core.drag.dtNormal=1;core.drag.dtDragDrop=5;core.drag.dtCustom=6;var dragObj={};dragObj.elm=null;dragObj.trueElm=null;dragObj.DragStart=null;dragObj.DragMove=null;dragObj.DragEnd=null;dragObj.cursorStartX=0;dragObj.cursorStartY=0;dragObj.k=1;dragObj.inDrag=false;dragObj.source=null;dragObj.dest=null;dragObj.index=-1;dragObj.anchorReleased=false;dragObj.tag=0;dragObj.dragThreshold=0;dragObj.domAPIObjType="DRAG";core.elmProto.turnOnDrag=function(t,k,thresh,fDragStart,fDragMove,fDragEnd){k=core.rInt(k,core.drag.dtNormal);thresh=core.rInt(thresh,(k==core.drag.dtNormal)?0:15);this._dragMDHandler=function(e){core.drag.dragStart(e,t,k,thresh,fDragStart,fDragMove,fDragEnd)};core.addEvent(this,"mousedown",this._dragMDHandler)};core.elmProto.turnOffDrag=function(){core.removeEvent(this,"mousedown",this._dragMDHandler);dragObj.inDrag=false};core.elmProto.cancelDrag=function(){dragObj.inDrag=false;dragObj.tag=0;core.removeEvent(document,"mousemove",core.drag.dragGo);core.removeEvent(document,"mouseup",core.drag.dragStop);if(dragObj.k==core.drag.dtDragDrop){core.insertElm(this,dragObj.source,"afterBegin");if(dragObj.dest){if(typeof dragObj.dest.reDraw=="function")dragObj.dest.reDraw()}}};core.drag.dragStart=function(e,t,k,thresh,fDragStart,fDragMove,fDragEnd){core.preventBubble(e);if(dragObj.inDrag)return;if(core.isNS)e.preventDefault();dragObj.k=k;dragObj.dragThreshold=thresh;dragObj.DragStart=fDragStart;dragObj.DragMove=fDragMove;dragObj.DragEnd=fDragEnd;dragObj.dest=null;dragObj.anchorReleased=false;dragObj.trueElm=core.getTarget(e);if(t)dragObj.elm=t;else{dragObj.elm=core.getTarget(e);if(dragObj.elm.nodeType==3||dragObj.elm.nodeName=="IMG")dragObj.elm=dragObj.elm.parentNode}if(typeof dragObj.elm.getX!="function")return;dragObj.inDrag=true;dragObj.cursorStartX=core.isIE?event.clientX+document.documentElement.scrollLeft+document.body.scrollLeft:e.clientX+window.scrollX;dragObj.cursorStartY=core.isIE?event.clientY+document.documentElement.scrollTop+document.body.scrollTop:e.clientY+window.scrollY;dragObj.index=core.getNodeIndex(dragObj.elm);dragObj.source=dragObj.elm.parentNode;dragObj.elStartLeft=core.rInt(dragObj.elm.getX());dragObj.elStartTop=core.rInt(dragObj.elm.getY());dragObj.elm.draggable=true;dragObj.elm.inDrag=false;dragObj.elm.bringToFront();core.addEvent(document,"mousemove",core.drag.dragGo);core.addEvent(document,"mouseup",core.drag.dragStop);if(dragObj.DragStart)dragObj.DragStart(dragObj.cursorStartX,dragObj.cursorStartY)};core.drag.dragGo=function(e){core.preventBubble(e);var t=core.getTarget(e);if(t!=dragObj.elm)dragObj.dest=t;var cX=core.isIE?event.clientX+document.documentElement.scrollLeft+document.body.scrollLeft:e.clientX+window.scrollX;var cY=core.isIE?event.clientY+document.documentElement.scrollTop+document.body.scrollTop:e.clientY+window.scrollY;var eX=dragObj.elStartLeft+cX-dragObj.cursorStartX;var eY=dragObj.elStartTop+cY-dragObj.cursorStartY;var dX=eX-dragObj.elStartLeft;var dY=eY-dragObj.elStartTop;if(!dragObj.anchorReleased){if(dragObj.k==core.drag.dtNormal){dragObj.anchorReleased=true;if(core.useElmHooks&&dragObj.elm._dispHook)dragObj.elm._dispHook("dragStart",arguments)}else if((Math.abs(dX)>dragObj.dragThreshold)||(Math.abs(dY)>dragObj.dragThreshold)){dragObj.anchorReleased=true;if(core.useElmHooks&&dragObj.elm._dispHook)dragObj.elm._dispHook("dragStart",arguments);if(dragObj.k==core.drag.dtDragDrop){core.insertElm(dragObj.elm,core.bodyElm(),"beforeEnd");dragObj.elm.setPosition("absolute");dragObj.elm.moveTo(cX,cY)}}else return}if(dragObj.anchorReleased&&dragObj.DragMove){dragObj.DragMove(eX,eY,dX,dY);return};if(dragObj.k==core.drag.dtDragDrop){dragObj.elm.moveTo(cX,cY);return};if(dragObj.k==core.drag.dtNormal){dragObj.elm.moveTo(eX,eY);return}};core.drag.dragStop=function(e){dragObj.inDrag=false;core.removeEvent(document,"mousemove",core.drag.dragGo);core.removeEvent(document,"mouseup",core.drag.dragStop);var t=null;if(dragObj.elm.resizeStatus)core.resize._resetControls(dragObj.elm);if(dragObj.elm.reflowStatus)core.reflow.initValues(dragObj.elm);if(dragObj.k==core.drag.dtDragDrop||dragObj.k==core.drag.dtCustom){if(!dragObj.anchorReleased){if(dragObj.DragEnd)dragObj.DragEnd(false,-1);return}var childIndex=-1;t=dragObj.dest;while(t){if(typeof t.ondragdrop=="function"){dragObj.accept=t.ondragdrop(dragObj.source);if(dragObj.accept)break}childIndex=core.getNodeIndex(t);t=t.parentNode}if(!t)dragObj.accept=false;if(!dragObj.accept){dragObj.elm.cancelDrag();if(dragObj.DragEnd)dragObj.DragEnd(false,-1);return}}if(dragObj.k==core.drag.dtDragDrop){if(childIndex<0||(dragObj.elm,t.childNodes[childIndex]=="undefined"))core.insertElm(dragObj.elm,t,"beforeEnd");else core.insertElm(dragObj.elm,t.childNodes[childIndex],"beforeBegin");if(t){if(typeof t.reDraw=="function")t.reDraw()}else if(dragObj.dest){if(typeof dragObj.dest.reDraw=="function")dragObj.dest.reDraw()}if(dragObj.src&&(typeof dragObj.src.reDraw=="function"))dragObj.src.reDraw()}if(dragObj.DragEnd)dragObj.DragEnd(true,childIndex);if(dragObj.anchorReleased&&core.useElmHooks&&dragObj.elm._dispHook)dragObj.elm._dispHook("dragStop",arguments)};core.drag.dragBasin=function(x,y,dX,dY){var c=[];for(var f=0;f<this.elm.xBasin.length;f++)c[f]=Math.abs(this.elm.xBasin[f]-x)+Math.abs(this.elm.yBasin[f]-y);var d=0;for(f=1;f<c.length;f++)if(c[f]<c[d])d=f;this.elm.moveTo(this.elm.xBasin[d],this.elm.yBasin[d]);if(d!=this.elm.basinIndex){this.elm.basinIndex=d;if(this.elm.onBasinChange)this.elm.onBasinChange(d)}};core.drag.dragRange=function(x,y,dX,dY){var e=this.elm;if(x<e.rangeStart[0])x=e.rangeStart[0];if(y<e.rangeStart[1])y=e.rangeStart[1];if(x>e.rangeEnd[ 0])x=e.rangeEnd[ 0];if(y>e.rangeEnd[ 1])y=e.rangeEnd[ 1];e.moveTo(x,y);var xp=parseInt(((x-e.rangeStart[0])/(e.rangeEnd[0]-e.rangeStart[0]))*100);var yp=parseInt(((y-e.rangeStart[1])/(e.rangeEnd[1]-e.rangeStart[1]))*100);if(this.elm.onRangeChange)this.elm.onRangeChange(xp,yp)};
